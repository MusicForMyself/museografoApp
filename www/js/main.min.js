var app={app_context:this,initialize:function(){this.bindEvents(),$.ajaxSetup({async:!1}),this.ls=window.localStorage;var e=JSON.parse(this.ls.getItem("museo_log_info"));if(window.user=e?e.user_login:"",window.user_id=e?e.user_id:"",window.user_role=e?e.user_role:"",window.apiRH=(new requestHandlerAPI).construct(app),apiRH.has_token()){var a=apiRH.has_valid_token();if(a){{$(this).data("id")}console.log("You okay, now you can start making calls");var t=window.is_home;return void(t&&window.location.assign("feed.html?filter_feed=all"))}return void console.log("Your token is not valid anymore (or never was D:)")}console.log(JSON.stringify(apiRH.getRequest("robots",null))),console.log(apiRH.request_token().get_request_token())},bindEvents:function(){document.addEventListener("deviceready",app.onDeviceReady,!1),document.addEventListener("mobileinit",app.onDMobileInit,!1)},onDeviceReady:function(){app.receivedEvent("deviceready");try{OAuth.initialize("7O8IRe-xiPNc0JrOXSv3rc90RmU")}catch(e){console.log("OAuth initialize error: "+e)}},onMobileInit:function(){app.receivedEvent("mobileinit")},receivedEvent:function(e){"deviceready"==e&&console.log("Received event deviceready")},getUrlVars:function(){{var e={};window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(a,t,o){e[t]=o})}return e},getFormData:function(e){return $(e).serializeJSON()},isObjEmpty:function(e){if(null==e)return!0;if(e.length>0)return!1;if(0===e.length)return!0;for(var a in e)if(hasOwnProperty.call(e,a))return!1;return!0},header_partial:function(){return"	<div id='spinner' class='spinner'>	  <div class='spinner-container container1'>	    <div class='circle1'></div>	    <div class='circle2'></div>	    <div class='circle3'></div>	    <div class='circle4'></div>	  </div>	  <div class='spinner-container container2'>	    <div class='circle1'></div>	    <div class='circle2'></div>	    <div class='circle3'></div>	    <div class='circle4'></div>	  </div>	  <div class='spinner-container container3'>	    <div class='circle1'></div>	    <div class='circle2'></div>	    <div class='circle3'></div>	    <div class='circle4'></div>	  </div>	</div>	<div data-role='panel' id='main_drop' class='menu' data-position='left' data-display='push'>		<ul>			<li class='menu_profile'><a href='my-profile.html' rel='external'><img class='slight_radius' src='{{profile_pic}}'></a></li>			<li class='menu_profile_name'><a href='my-profile.html' rel='external'><h1>{{user_login}}</h1></a></li>			<li class='feed'><a href='feed.html?filter_feed=all' rel='external'><i class='fa fa-newspaper-o'></i> Eventos</a></li>			<li class='feed'><a href='timeline.html' rel='external'><i class='fa fa-home'></i> Actividad</a></li>			<li class='agenda'><a href='my-events.html' rel='external'><i class='fa fa-calendar'></i> Mi agenda</a></li>			<li class='profile'><a href='follow-categories.html' rel='external'><i class='fa fa-tags'></i> Intereses</a></li>			<li class='profile settings'><a href='my-profile.html' rel='external'><i class='fa fa-user'></i> Mi Perfil</a></li>			<li class='logout settings'><a id='logout'><i class='fa fa-sign-out'></i> Cerrar sesión</a></li>			<li class='disclaimer'>Todos los derechos &reg; Museógrafo 2015</li>			<li class='disclaimer'><a href='mailto:hola@marat.mx'>hola@marat.mx</a></li>			<li class='disclaimer'><a onclick='window.open('http://app.museografo.com/aviso-de-privacidad', '_blank', 'location=yes');'>Aviso de privacidad</a></li>		</ul>	</div>	<div data-role='panel' id='notifications_drop' class='menu' data-position='right' data-display='push'>		<ul>			<li class='divider'>Notificaciones</li>			{{#if count}}				{{#each pool}}					{{#if follow}}						<li class='each_notification {{#if estatus}}read{{/if}} clearfix'>							<a href='user.html?user={{user_login}}' rel='external' data-id='{{alerta_id}}' class='plus_btn right'><p><strong>{{user_login}}</strong> te ha empezado a seguir.</p>							<i class='fa fa-plus-circle'></i></a>						</li>					{{/if}}					{{#if vote}}						<li class='each_notification {{#if estatus}}read{{/if}} clearfix'>							<a href='single-event.html?event={{objeto_id}}' rel='external' data-id='{{alerta_id}}' class='plus_btn right'><p><strong>{{user_login}}</strong> votó tu comentario en el evento <strong>{{event_title}}</strong>.</p>							<i class='fa fa-plus-circle'></i></a>						</li>					{{/if}}					{{#if recommend}}						<li class='each_notification {{#if estatus}}read{{/if}} clearfix' >							<a href='single-event.html?event={{objeto_id}}' data-id='{{alerta_id}}' rel='external' class='plus_btn right'><p><strong>{{user_login}}</strong> te ha recomendado el evento <strong>{{event_title}}</strong>.</p>							<i class='fa fa-plus-circle'></i></a>						</li>					{{/if}}				{{/each}}			{{/if}}			{{#unless pool}}					<li class='clearfix'>						<p><strong>No tienes notificaciones</strong></p>					</li>			{{/unless}}		</ul>	</div>	<div data-role='header' data-tap-toggle='false' class='fixed_header' data-position='fixed'>		<a data-role='none' data-corners='false' href='#main_drop'  class='ui-btn-left menu_trigger'><i class='fa fa-bars'></i></a>		<h1 class='page_title'>			<form id='search_form' method='GET' action='search.html' data-ajax='false'>				<input type='search' data-corners='false' name='searchbox' id='searchbox' placeholder='¿Qué estás buscando?'>				<input type='submit' data-role='none' class='invisibo_submito' id='searchbox_submit' value=''>			</form>		</h1>		<a data-role='none' href='#notifications_drop' data-corners='false' class='ui-btn-right circle notifications notifications_trigger'>{{count}}</a>	</div>"},comments_partial:function(){return"<section class='comments border_c no_box clearfix'>						<h2>Reseñas ({{comment_count}})</h2>						{{#each pool}}						<article class='each_comment'>							<img src='{{author_thumbnail}}' class='comment_user_thumb'>							<h3>{{author_name}}</h3>							<p>{{content}}</p>							{{!-- <div class='votes'>								<a class='downvote'><i class='fa fa-thumbs-down'></i></a>								<a class='upvote'><i class='fa fa-thumbs-up'></i></a>							</div> --}}						</article>						{{/each}}						{{#unless pool}}						<p class='information'>¡Se el primero en reseñar este evento!</p>						{{/unless}}						<section id='comment_form' class='comment_form'>							<form id=''>								<label for='comment_content'>Escribe tu reseña:</label>								<textarea name='comment_content' id='comment_content'></textarea>							</form>						</section>						<a class='comment_btn' id='comment_button' data-role='none'><i class='fa fa-share'></i></a>					</section>"},province_select_partial:function(){return"				<select id='user_province' name='user_province'>					<option value='>Provincia/ciudad</option>					{{#each .}}						<option value='{{slug}}'>{{name}}</option>					{{/each}}				</select>"},render_login_content:function(){$.getJSON(api_base_url+"content/login/",function(e){var a=$("#login_screen_template").html(),t=Handlebars.compile(a);$("#index_container").html(t(e.data))}).fail(function(e){console.log(JSON.stringify(e))})},get_events_feed:function(e,a){$.getJSON(api_base_url+user+"/events/feed/"+e+"/"+a,function(e){console.log(e);var a=$("#event_feed_entry_template").html(),t=Handlebars.compile(a);$(".feed_container").html(t(e))}).fail(function(e){console.log(e)})},get_user_timeline:function(e){$.getJSON(api_base_url+user+"/timeline/"+e,function(a){console.log(a),e++;var t={};t.results=a;var o=$("#event_entry_template").html(),i=Handlebars.compile(o);return $(".feed_container").append(i(t)),$("#load_more_posts").length>0&&$("#load_more_posts").remove(),t.results.length<10?void $(".feed_container").append("<a class='load_more' data-role='none'>No hay más actividad</a>"):void $(".feed_container").append("<a class='load_more' id='load_more_posts' data-role='none' data-page='"+e+"'><i class='fa fa-refresh'></i> Cargar más</a>")}).fail(function(e){console.log(e)})},render_header:function(){$.getJSON(api_base_url+user+"/notifications",function(e){var a=app.header_partial(),t=Handlebars.compile(a);$(".main").prepend(t(e)).trigger("create")})},render_event_gallery:function(e){$.getJSON(api_base_url+"events/"+e+"/gallery",function(e){var a=$("#event_gallery_template").html(),t=Handlebars.compile(a);$(".append_gallery").prepend(t(e)).trigger("create"),imagesLoaded($(".gallery_list"),function(){$(".gallery_list").cycle({paused:!0,slides:">li",fx:"scrollHorz",swipe:!0})})})},render_event_popup:function(e){var a=$("#event_popup_template").html(),t=Handlebars.compile(a);$(".main").append(t({event_id:e})).trigger("create")},render_comments:function(e,a){$.getJSON(api_base_url+"events/comments/"+e+"/"+a,function(e){var a=app.comments_partial(),t=Handlebars.compile(a);$(".main").append(t(e.data))})},render_event:function(e){$.getJSON(api_base_url+user+"/events/"+e,function(a){var t=$("#event_single_template").html(),o=Handlebars.compile(t);$(".feed_container").append(o(a)).trigger("create"),app.render_event_gallery(e),app.render_comments(e,0)})},render_my_schedule:function(e){$.getJSON(api_base_url+user+"/scheduled_feed/"+e,function(e){var a=$("#event_single_template").html(),t=Handlebars.compile(a);$(".feed_container").append(t(e))})},render_user:function(e){$.getJSON(api_base_url+user+"/user/"+e,function(e){var a=$("#user_profile_template").html(),t=Handlebars.compile(a);$(".feed_container").append(t(e)).trigger("create")})},render_user_profile:function(e){$.getJSON(api_base_url+user+"/user/"+e,function(e){var a=$("#user_profile_template").html(),t=Handlebars.compile(a);$(".feed_container").prepend(t(e)).trigger("create")})},render_my_profile:function(){$.getJSON(api_base_url+user+"/user/"+user,function(e){var a=$("#my_profile_template").html(),t=Handlebars.compile(a);$(".feed_container").prepend(t(e)).trigger("create")})},render_categories:function(){$.getJSON(api_base_url+user+"/categories/0",function(e){var a=$("#category_template").html(),t=Handlebars.compile(a);$(".feed_container").append(t(e)).trigger("create")})},render_subcategories:function(e){$.getJSON(api_base_url+user+"/categories/"+e,function(e){console.log(e);var a=$("#subcategory_template").html(),t=Handlebars.compile(a);$(".feed_container").append(t(e)).trigger("create")})},render_category_detail:function(e){$.getJSON(api_base_url+user+"/category/"+e,function(e){console.log(e);var a=$("#category_detail_template").html(),t=Handlebars.compile(a);$(".feed_container").append(t(e.data)).trigger("create")})},render_schedule_first_events:function(e){$.getJSON(api_base_url+user+"/events/feed/"+e,function(e){console.log(e);var a=$("#event_entry_template").html(),t=Handlebars.compile(a);$(".feed_container").append(t(e)).trigger("create")})},render_venue_profile:function(e){$.getJSON(api_base_url+user+"/venues/"+e,function(e){var a=$("#venue_profile_template").html(),t=Handlebars.compile(a);$(".feed_container").append(t(e.data)).trigger("create")})},render_discover_screen:function(){$.getJSON(api_base_url+user+"/feeds/discover/",function(e){var a=$("#discover_template").html(),t=Handlebars.compile(a);$(".feed_container").append(t(e.data)).trigger("create")})},get_search_results:function(e,a){$.getJSON(api_base_url+"user/"+user+"/search/"+e+"/"+a,function(e){var t=$("#search_entry_template").html(),o=Handlebars.compile(t);return a++,$(".feed_container").append(o(e.data)).trigger("create"),$("#load_more_results").length>0&&$("#load_more_results").remove(),e.data.results.length<10?void $(".feed_container").append("<a class='load_more' data-role='none'>No hay más resultados</a>"):void $(".feed_container").append("<a class='load_more' id='load_more_results' data-role='none' data-page='"+a+"'><i class='fa fa-refresh'></i> Cargar más</a>")})},get_user_followers:function(e,a){a||(a="any"),$.getJSON(api_base_url+user+"/user/"+e+"/followers/"+a,function(e){var a=$("#follower_entry_template").html(),t=Handlebars.compile(a);$(".feed_container").append(t(e.data)).trigger("create")})},get_user_followees:function(e,a){a||(a="any"),$.getJSON(api_base_url+user+"/user/"+e+"/followees/"+a,function(e){var a=$("#follower_entry_template").html(),t=Handlebars.compile(a);$(".feed_container").append(t(e.data)).trigger("create")})},set_selected_filter:function(e){$(".tab_button").filter(function(){return $(this).data("rel")==e}).addClass("selected")},set_query_title:function(e){$(".insert_query").text('"'+e+'"')},set_selected_city:function(e){if(console.log(e),!e||""==e)return!1;var a=$("#city option[value='"+e+"']");console.log(a),a.prop("selected","selected"),$("#city").change()},get_file_from_gallery:function(e){apiRH.getFileFromGallery(e)},showLoader:function(){$("#spinner").show()},hideLoader:function(){$("#spinner").hide()},toast:function(e,a){try{a?window.plugins.toast.showLongBottom(e):window.plugins.toast.showLongCenter(e)}catch(t){console.log("Toasting error: "+JSON.stringify(t)),alert(e)}}};jQuery(document).ready(function(e){e("#login_form").submit(function(e){app.showLoader(),e.preventDefault();var a=app.getFormData("#login_form"),t=apiRH.loginNative(a);t&&(apiRH.save_user_data_clientside(t),window.location.assign("feed.html?filter_feed=all"))}),e("#register_us").on("tap",function(){e("#register_form").slideToggle("fast"),e(".login_area").slideToggle("fast"),e(".add_text").text(e(".add_text").text()+" regístrate con nosotros"),e(this).remove()}),e("#register_form").validate({rules:{user_login_reg:"required",user_email_reg:{required:!0,email:!0},user_country:"required",i_accept_terms:"required"},messages:{user_login_reg:"Debes proporcionar un username",user_email_reg:{required:"Debes proporcionar un email",email:"Por favor proporciona un email válido"},user_country:"Por favor selecciona tu país",i_accept_terms:"Debes aceptar los términos y condiciones para continuar"},submitHandler:function(a){var t=app.getFormData("#register_form");t.user_password_reg=e("#user_password_reg").val(),console.log(t);var o=apiRH.registerNative(t);return o?(apiRH.save_user_data_clientside(o),void window.location.assign("feed.html?filter_feed=all")):(app.toast("Lo sentimos, el nombre de usuario ya existe."),void a.preventDefault())}}),e("body").on("click","#logout",function(){var e=apiRH.logOut({user_login:user,request_token:apiRH.get_request_token()});return e.success?(app.toast("Hasta pronto! Tu sesión ha sido cerrada"),app.ls.removeItem("museo_log_info"),app.ls.removeItem("request_token"),void window.location.assign("index.html")):void app.toast("Ocurrió un problema al intentar cerrar tu sesión")}),e("body").on("change","#user_country",function(){var a=e(this).val(),t={};t.country=a,console.log(t),console.log(JSON.stringify(t));var o=apiRH.getRequest("assets/provinces/"+encodeURIComponent(JSON.stringify(t)),null);if(o.success){var i=app.province_select_partial(),s=Handlebars.compile(i);e("#insert_select").append(s(o.pool)).trigger("create")}}),e("body").on("click","a.close",function(){var a=e(this).data("id"),t=apiRH.makeRequest(user+"/unschedule",{evento_id:a});t&&(e(this).parent().slideUp("fast"),e(this).parent().slideUp("fast"))}),e("body").on("tap",".select_me",function(a){if(!e(this).hasClass("selected")){var t=e(this).data("id"),o=apiRH.makeRequest(user+"/categories/follow",{cat_id:t});if(o)return e(this).addClass("selected"),void a.stopPropagation()}var t=e(this).data("id"),o=apiRH.makeRequest(user+"/categories/unfollow",{cat_id:t});return o?(e(this).removeClass("selected"),void a.stopPropagation()):void 0}),e(".main").on("tap",".each_notification a",function(a){a.preventDefault();var t=e(this).attr("href"),o=e(this);if(o.hasClass("read"))return!1;var i=o.data("id"),s=apiRH.makeRequest(user+"/notifications/read/"+i);console.log(s),s&&o.addClass("read"),window.location.assign(t)}),e("body").on("click",".schedule_this",function(){app.showLoader();var a=e(this).data("id"),t=apiRH.makeRequest(user+"/schedule",{evento_id:a});t&&(e(this).removeClass("schedule_this").addClass("active unschedule_this").html("<i class='fa fa-calendar'></i><i class='fa fa-check superscript'></i>"),app.toast("Se agendó un nuevo evento"),app.hideLoader())}),e("body").on("click",".unschedule_this",function(){app.showLoader();var a=e(this).data("id"),t=apiRH.makeRequest(user+"/unschedule",{evento_id:a});t&&(e(this).removeClass("active unschedule_this").addClass("schedule_this").find(".superscript").remove(),app.toast("Se eliminó un evento de tu agenda"),app.hideLoader())});var a=function(a,t){if(0!=e("#"+t+"_follower_count").length){console.log("user/"+a+"/follower_count/"+t);var o=apiRH.getRequest("user/"+a+"/follower_count/"+t,null),i="";"museografo"==t&&(i="<span>Museógrafos</span>"),"venue"==t&&(i="<span>Venues</span>"),"artista"==t&&(i="<span>Artistas</span>"),e("#"+t+"_follower_count").html(o+i)}};e("body").on("click","#follow_user",function(){var t=e(this).hasClass("special_icon")?!0:!1,o=e(this).data("id"),i=e(this).data("userrole"),s=e(this).data("userlogin"),r=i&&""!=i?e(this).data("userrole"):"usuario";r="suscriptor"==r?"museógrafo":r;window.localStorage.getItem("museo_log_info");("administrator"==user_role||"administrador"==user_role)&&(user_role="suscriptor");var n=apiRH.makeRequest(user+"/follow",{user_id:o,type:user_role});return n.success?t?(e(this).removeClass("follow_user").addClass("unfollow_user").attr("id","unfollow_user").html('<i class="fa fa-user"></i> <i class="fa fa-check superscript"></i>'),void app.toast("Ahora sigues un nuevo "+r+".")):(e(this).removeClass("follow_user").addClass("unfollow_user").attr("id","unfollow_user").html("Dejar de seguir"),app.toast("Ahora sigues un nuevo "+r+"."),void a(s,r)):void 0}),e("body").on("click","#unfollow_user",function(){var t=e(this).hasClass("special_icon")?!0:!1,o=e(this).data("id"),i=e(this).data("userrole"),s=e(this).data("userlogin"),r=i&&""!=i?e(this).data("userrole"):"usuario";r="suscriptor"==r?"museógrafo":r;var n=apiRH.makeRequest(user+"/unfollow",{user_id:o});return n.success?t?(e(this).removeClass("unfollow_user").addClass("follow_user").attr("id","follow_user").html('<i class="fa fa-user"></i> <i class="fa fa-plus superscript"></i>'),void app.toast("Has dejado de seguir un "+r)):(e(this).removeClass("unfollow_user").addClass("follow_user").attr("id","follow_user").html("Seguir"),app.toast("Has dejado de seguir un "+r),void a(s,r)):void 0}),e("body").on("submit","#recomend_to",function(a){a.preventDefault();var t=app.getFormData("#recomend_to"),o=apiRH.makeRequest(user+"/recomend",{evento_id:t.event_id,user_reco:t.user_rec,mensaje:t.comment});console.log(o),o&&(e(".close_dialog").trigger("click"),app.toast("Invitación enviada!"))}),e("body").on("submit","#modify_profile",function(e){e.preventDefault();var a=app.getFormData("#modify_profile");if(a.password_nuevo&&""!==a.password_nuevo){if(console.log("Lo vamos a cambiar"),a.password_nuevo==a.password_again){console.log("son iguales!");var t=apiRH.putRequest("user/"+user+"/password/",a);if(!t.success)return app.toast("There was an error saving your password"),!1;console.log(t)}app.toast("Tus passwords no coinciden")}var t=apiRH.putRequest("user/"+user+"/",a);t.success&&(console.log(t),app.toast("Tu información ha sido actualizada"))}),e(document).on("tap",".login_button",function(){var a=e(this).data("provider");"facebook"==a&&apiRH.loginOauth(a,apiRH.loginCallbackFB),"twitter"==a&&apiRH.loginOauth(a,apiRH.loginCallbackTW)}),e(document).on("tap","#load_more_posts",function(a){a.preventDefault();var t=e(this).data("page");app.get_user_timeline(t),a.stopPropagation()}),e(document).on("tap","#load_more_results",function(a){a.preventDefault();var t=e(this).data("page"),o=app.getUrlVars();app.get_search_results(o.searchbox,t),a.stopPropagation()}),e("#attend_event").on("tap",function(){console.log("Attending event");var a=e(this).data("eventid"),t=apiRH.makeRequest(user+"/events/attend",{post_ID:a});return t.success?void e(this).removeClass("attend_event").addClass("attended_event").html('Asistido <i class="fa fa-check-square-o">'):void 0}),e("#comment_button").on("tap",function(){var a=e("#hidden_event_id").val(),t=e("#comment_content").val(),o=apiRH.makeRequest(user+"/events/comments/",{event_id:a,comment_content:t});return o.success?void window.location.reload():void app.toast("Ha ocurrido un error al postear tu comentario")}),e("#user_rec").on("change keyup",function(){var a=e(this).val(),t="",o=apiRH.getRequest(user+"/search/"+a,null);o.data.forEach(function(e){t+="<li class='fill_input' data-value='"+e+"'>"+e+"</li>"}),e("#hidden_list").html(t).show().delay(6e3).fadeOut("fast")}),e(document).on("tap",".fill_input",function(){var a=e(this).data("value");e("#user_rec").val(a),e("#hidden_list").html("").fadeOut("fast")}),e(document).on("tap","a[rel=external]",function(){app.showLoader()}),e(document).on("tap","._nav_follow_category",function(a){a.preventDefault();var t=e(this),o=e(this).data("id"),i=apiRH.makeRequest(user+"/categories/follow/",{cat_id:o});return console.log(i),a.stopPropagation(),i.success?(app.toast("Sigues una nueva categoría"),t.removeClass("_nav_follow_category follow_category").addClass("_nav_unfollow_category unfollow_category"),t.hasClass("inline")?void t.html('<i class="fa fa-check"></i>'):(t.html('<i class="fa fa-check"></i> Siguiendo'),void a.stopPropagation())):app.toast("Oops! ocurrió un error")}),e(document).on("tap","._nav_unfollow_category",function(a){a.preventDefault();var t=e(this),o=e(this).data("id"),i=apiRH.makeRequest(user+"/categories/unfollow/",{cat_id:o});return console.log(i),a.stopPropagation(),i.success?(app.toast("Dejaste de seguir una categoría"),t.removeClass("_nav_unfollow_category unfollow_category").addClass("_nav_follow_category follow_category"),t.hasClass("inline")?void t.html('<i class="fa fa-plus-circle"></i>'):void t.html('<i class="fa fa-plus-circle"></i> Seguir')):app.toast("Oops! ocurrió un error")}),e("#event_file_upload").on("tap",function(){var a=window.localStorage;a.setItem("museo_last_selected_event",e(this).data("eventid")),app.get_file_from_gallery("event")}),e("#mod_user_profile").on("tap",function(){app.get_file_from_gallery("profile")})});