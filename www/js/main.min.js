var app={app_context:this,initialize:function(){this.bindEvents(),$.ajaxSetup({async:!1}),app.registerPartials(),this.ls=window.localStorage;var e=JSON.parse(this.ls.getItem("museo_log_info"));if(window.user=e?e.user_login:"",window.user_id=e?e.user_id:"",window.user_role=e?e.user_role:"",window.apiRH=(new requestHandlerAPI).construct(app),apiRH.has_token()){var a=apiRH.has_valid_token();if(a){$(this).data("id");console.log("You okay, now you can start making calls");var t=window.is_home;return void(t&&window.location.assign("feed.html?filter_feed=all"))}return void console.log("Your token is not valid anymore (or has not been activated yet)")}console.log(apiRH.request_token().get_request_token())},registerPartials:function(){var e=["header","comments","gallery_base"];e.forEach(function(e){$.ajax({url:"views/partials/"+e+".hbs",success:function(a){void 0===Handlebars.templates&&(Handlebars.templates={}),Handlebars.templates[e]=Handlebars.compile(a)}})})},registerTemplate:function(e){$.ajax({url:"views/"+e+".hbs",success:function(a){void 0===Handlebars.templates&&(Handlebars.templates={}),Handlebars.templates[e]=Handlebars.compile(a)}})},bindEvents:function(){document.addEventListener("deviceready",app.onDeviceReady,!1),document.addEventListener("mobileinit",app.onDMobileInit,!1)},onDeviceReady:function(){app.receivedEvent("deviceready");try{OAuth.initialize("7O8IRe-xiPNc0JrOXSv3rc90RmU")}catch(e){console.log("OAuth initialize error: "+e)}},onMobileInit:function(){app.receivedEvent("mobileinit")},receivedEvent:function(e){"deviceready"==e&&"undefined"!=typeof navigator.splashscreen&&navigator.splashscreen.hide()},getUrlVars:function(){var e={};window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(a,t,r){e[t]=r});return e},getFormData:function(e){return $(e).serializeJSON()},isObjEmpty:function(e){if(null==e)return!0;if(e.length>0)return!1;if(0===e.length)return!0;for(var a in e)if(hasOwnProperty.call(e,a))return!1;return!0},province_select_partial:function(){return"				<select id='user_province' name='user_province'>					<option value='>Provincia/ciudad</option>					{{#each .}}						<option value='{{slug}}'>{{name}}</option>					{{/each}}				</select>"},render_login_content:function(){$.getJSON(api_base_url+"content/login/",function(e){var a=$("#login_screen_template").html(),t=Handlebars.compile(a);$("#index_container").html(t(e.data))}).fail(function(e){console.log(JSON.stringify(e))})},get_events_feed:function(e,a){$.getJSON(api_base_url+user+"/events/feed/"+e+"/"+a,function(e){app.registerTemplate("feed");var t=Handlebars.templates.feed(e);$(".feed_container").html(t),app.set_selected_filter(a)}).fail(function(e){console.log(e)}).done(function(e){app.render_header()})},get_user_timeline:function(e){$.getJSON(api_base_url+user+"/timeline/"+e,function(a){e++;var t={};t.results=a;var r=$("#event_entry_template").html(),n=Handlebars.compile(r);return $(".feed_container").append(n(t)),$("#load_more_posts").length>0&&$("#load_more_posts").remove(),t.results.length<10?void $(".feed_container").append("<a class='load_more' data-role='none'>No hay más actividad</a>"):void $(".feed_container").append("<a class='load_more' id='load_more_posts' data-role='none' data-page='"+e+"'><i class='fa fa-refresh'></i> Cargar más</a>")}).fail(function(e){console.log(e)}).done(function(e){app.render_header()})},render_header:function(){$.getJSON(api_base_url+user+"/notifications",function(e){var a=Handlebars.templates.header(e);$(".main").prepend(a).trigger("create")})},render_event_minigallery:function(e,a){$.getJSON(api_base_url+"events/"+e+"/gallery/"+a+"/thumbnail/",function(e){app.registerTemplate("mini_event_gallery");var a=Handlebars.templates.mini_event_gallery(e);$(".append_gallery").prepend(a).trigger("create")})},render_event_popup:function(e){app.registerTemplate("event_popup");var a=Handlebars.templates.event_popup({event_id:e});$(".main").append(a).trigger("create")},render_comments:function(e,a){$.getJSON(api_base_url+"events/comments/"+e+"/"+a,function(e){var a=Handlebars.templates.comments(e.data);$(".main").append(a)})},render_event:function(e){app.render_header(),$.getJSON(api_base_url+user+"/events/"+e,function(e){app.registerTemplate("single_event");var a=Handlebars.templates.single_event(e);$(".feed_container").append(a).trigger("create")}),app.render_event_minigallery(e,5),app.render_comments(e,0),app.render_event_gallery_partial(e),app.render_event_popup(e)},render_my_schedule:function(e){$.getJSON(api_base_url+user+"/scheduled_feed/"+e,function(e){var a=$("#event_single_template").html(),t=Handlebars.compile(a);$(".feed_container").append(t(e))})},render_user:function(e){$.getJSON(api_base_url+user+"/user/"+e,function(e){var a=$("#user_profile_template").html(),t=Handlebars.compile(a);$(".feed_container").append(t(e)).trigger("create")})},render_user_profile:function(e){$.getJSON(api_base_url+user+"/user/"+e,function(e){var a=$("#user_profile_template").html(),t=Handlebars.compile(a);$(".feed_container").prepend(t(e)).trigger("create"),e.is_artista&&(app.render_artist_project_partial(e.user_login),app.render_artist_picsmini(e.user_login))})},render_user_picsmini:function(e){$.getJSON(api_base_url+"user/"+e+"/gallery/5/thumbnail/",function(e){var a=$("#user_picsmini").html(),t=Handlebars.compile(a);$(".feed_container").prepend(t(e)).trigger("create")})},render_artist_picsmini:function(e){$.getJSON(api_base_url+"user/"+e+"/projects/99/thumbnail/",function(e){var a=$("#mini_projects_template").html(),t=Handlebars.compile(a);$(".artist_project_mini").append(t(e))})},render_my_profile:function(){$.getJSON(api_base_url+user+"/user/"+user,function(e){var a=$("#my_profile_template").html(),t=Handlebars.compile(a);$(".feed_container").prepend(t(e)).trigger("create")})},render_categories:function(){$.getJSON(api_base_url+user+"/categories/0",function(e){var a=$("#category_template").html(),t=Handlebars.compile(a);$(".feed_container").append(t(e)).trigger("create")})},render_subcategories:function(e){$.getJSON(api_base_url+user+"/categories/"+e,function(e){var a=$("#subcategory_template").html(),t=Handlebars.compile(a);$(".feed_container").append(t(e)).trigger("create")})},render_category_detail:function(e){$.getJSON(api_base_url+user+"/category/"+e,function(e){var a=$("#category_detail_template").html(),t=Handlebars.compile(a);$(".feed_container").append(t(e.data)).trigger("create")})},render_schedule_first_events:function(e){$.getJSON(api_base_url+user+"/events/feed/"+e,function(e){var a=$("#event_entry_template").html(),t=Handlebars.compile(a);$(".feed_container").append(t(e)).trigger("create")})},render_venue_profile:function(e){$.getJSON(api_base_url+user+"/venues/"+e,function(e){var a=$("#venue_profile_template").html(),t=Handlebars.compile(a);$(".feed_container").append(t(e.data)).trigger("create")})},render_discover_screen:function(){$.getJSON(api_base_url+user+"/feeds/discover/",function(e){var a=$("#discover_template").html(),t=Handlebars.compile(a);$(".feed_container").append(t(e.data)).trigger("create")})},get_search_results:function(e,a){$.getJSON(api_base_url+"user/"+user+"/search/"+e+"/"+a,function(e){var t=$("#search_entry_template").html(),r=Handlebars.compile(t);return console.log(e),$(".feed_container").append(r(e.data)).trigger("create"),$("#load_more_results").length>0&&$("#load_more_results").remove(),0==e.data?void $(".feed_container").append("<a class='load_more' data-role='none'>No hay resultados para tu búsqueda</a>"):e.data.results.length<10?void $(".feed_container").append("<a class='load_more' data-role='none'>No hay más resultados</a>"):void $(".feed_container").append("<a class='load_more' id='load_more_results' data-role='none' data-page='"+a+"'><i class='fa fa-refresh'></i> Cargar más</a>")})},get_user_followers:function(e,a){a||(a="any"),$.getJSON(api_base_url+user+"/user/"+e+"/followers/"+a,function(e){var a=$("#follower_entry_template").html(),t=Handlebars.compile(a);$(".feed_container").append(t(e.data)).trigger("create")})},get_user_followees:function(e,a){a||(a="any"),$.getJSON(api_base_url+user+"/user/"+e+"/followees/"+a,function(e){var a=$("#follower_entry_template").html(),t=Handlebars.compile(a);$(".feed_container").append(t(e.data)).trigger("create")})},set_selected_filter:function(e){$(".tab_button").filter(function(){return $(this).data("rel")==e}).addClass("selected")},set_query_title:function(e){$(".insert_query").text('"'+e+'"')},set_selected_city:function(e){if(!e||""==e)return!1;var a=$("#city option[value='"+e+"']");a.prop("selected","selected"),$("#city").change()},get_file_from_device:function(e,a){apiRH.getFileFromDevice(e,a)},showLoader:function(){$("#spinner").show()},hideLoader:function(){$("#spinner").hide()},toast:function(e,a){try{a?window.plugins.toast.showLongBottom(e):window.plugins.toast.showLongCenter(e)}catch(t){console.log("Toasting error: "+JSON.stringify(t)),alert(e)}},render_event_gallery_partial:function(e){$.getJSON(api_base_url+"events/"+e+"/gallery/99/",function(e){var a=Handlebars.templates.gallery_base(e);$("body").append(a),window.event_temp_gallery_items=e.items})},render_user_gallery_partial:function(e){$.getJSON(api_base_url+"user/"+e+"/gallery/99/",function(e){var a=Handlebars.templates.gallery_base(e);$("body").append(a),window.user_temp_gallery_items=e.items})},render_artist_project_partial:function(e){$.getJSON(api_base_url+"user/"+e+"/projects/99/",function(e){var a=Handlebars.templates.gallery_base(e);$("body").append(a),window.user_temp_gallery_items=e.items})},trigger_event_gallery:function(e){window.event_gallery=null;var a=document.querySelectorAll(".pswp")[0],t=window.event_temp_gallery_items,r={history:!1,focus:!1,showAnimationDuration:0,hideAnimationDuration:0,index:e};window.event_gallery=new PhotoSwipe(a,PhotoSwipeUI_Default,t,r)},trigger_user_gallery:function(e){window.user_gallery=null;var a=document.querySelectorAll(".pswp")[0],t=window.user_temp_gallery_items,r={history:!1,focus:!1,showAnimationDuration:0,hideAnimationDuration:0,index:e};window.user_gallery=new PhotoSwipe(a,PhotoSwipeUI_Default,t,r)}};jQuery(document).ready(function(e){e("#login_form").submit(function(e){app.showLoader(),e.preventDefault();var a=app.getFormData("#login_form"),t=apiRH.loginNative(a);t&&(apiRH.save_user_data_clientside(t),window.location.assign("feed.html?filter_feed=all"))}),e("#register_us").on("tap",function(){e("#register_form").slideToggle("fast"),e(".login_area").slideToggle("fast"),e(".add_text").text(e(".add_text").text()+" regístrate con nosotros"),e(this).remove()}),e("#register_form").validate({rules:{user_login_reg:"required",user_email_reg:{required:!0,email:!0},user_country:"required",i_accept_terms:"required"},messages:{user_login_reg:"Debes proporcionar un username",user_email_reg:{required:"Debes proporcionar un email",email:"Por favor proporciona un email válido"},user_country:"Por favor selecciona tu país",i_accept_terms:"Debes aceptar los términos y condiciones para continuar"},submitHandler:function(a){var t=app.getFormData("#register_form");t.user_password_reg=e("#user_password_reg").val();var r=apiRH.registerNative(t);return r?(apiRH.save_user_data_clientside(r),void window.location.assign("feed.html?filter_feed=all")):(app.toast("Lo sentimos, el nombre de usuario ya existe."),void a.preventDefault())}}),e("body").on("click","#logout",function(e){var a=apiRH.logOut({user_login:user,request_token:apiRH.get_request_token()});return a.success?(app.toast("Hasta pronto! Tu sesión ha sido cerrada"),app.ls.removeItem("museo_log_info"),app.ls.removeItem("request_token"),void window.location.assign("index.html")):void app.toast("Ocurrió un problema al intentar cerrar tu sesión")}),e("body").on("change","#user_country",function(){var a=e(this).val(),t={};t.country=a;var r=apiRH.getRequest("assets/provinces/"+encodeURIComponent(JSON.stringify(t)),null);if(r.success){var n=app.province_select_partial(),o=Handlebars.compile(n);e("#insert_select").append(o(r.pool)).trigger("create")}}),e("body").on("click","a.close",function(){var a=e(this).data("id"),t=apiRH.makeRequest(user+"/unschedule",{evento_id:a});t&&(e(this).parent().slideUp("fast"),e(this).parent().slideUp("fast"))}),e("body").on("tap",".select_me",function(a){if(!e(this).hasClass("selected")){var t=e(this).data("id"),r=apiRH.makeRequest(user+"/categories/follow",{cat_id:t});if(r)return e(this).addClass("selected"),void a.stopPropagation()}var t=e(this).data("id"),r=apiRH.makeRequest(user+"/categories/unfollow",{cat_id:t});return r?(e(this).removeClass("selected"),void a.stopPropagation()):void 0}),e(".main").on("tap",".each_notification a",function(a){a.preventDefault();var t=e(this).attr("href"),r=e(this);if(r.hasClass("read"))return!1;var n=r.data("id"),o=apiRH.makeRequest(user+"/notifications/read/"+n);o&&r.addClass("read"),window.location.assign(t)}),e("body").on("click",".schedule_this",function(){app.showLoader();var a=e(this).data("id"),t=apiRH.makeRequest(user+"/schedule",{evento_id:a});t&&(e(this).removeClass("schedule_this").addClass("active unschedule_this").html("<i class='fa fa-calendar'></i><i class='fa fa-check superscript'></i>"),app.toast("Se agendó un nuevo evento"),app.hideLoader())}),e("body").on("click",".unschedule_this",function(){app.showLoader();var a=e(this).data("id"),t=apiRH.makeRequest(user+"/unschedule",{evento_id:a});t&&(e(this).removeClass("active unschedule_this").addClass("schedule_this").find(".superscript").remove(),app.toast("Se eliminó un evento de tu agenda"),app.hideLoader())});var a=function(a,t){if(0!=e("#"+t+"_follower_count").length){var r=apiRH.getRequest("user/"+a+"/follower_count/"+t,null),n="";"museografo"==t&&(n="<span>Museógrafos</span>"),"venue"==t&&(n="<span>Venues</span>"),"artista"==t&&(n="<span>Artistas</span>"),e("#"+t+"_follower_count").html(r+n)}};e("body").on("click","#follow_user",function(){var t=e(this).hasClass("special_icon")?!0:!1,r=e(this).data("id"),n=e(this).data("userrole"),o=e(this).data("userlogin"),i=n&&""!=n?e(this).data("userrole"):"usuario";i="suscriptor"==i?"museógrafo":i;window.localStorage.getItem("museo_log_info");("administrator"==user_role||"administrador"==user_role)&&(user_role="suscriptor");var s=apiRH.makeRequest(user+"/follow",{user_id:r,type:user_role});return s.success?t?(e(this).removeClass("follow_user").addClass("unfollow_user").attr("id","unfollow_user").html('<i class="fa fa-user"></i> <i class="fa fa-check superscript"></i>'),void app.toast("Ahora sigues un nuevo "+i+".")):(e(this).removeClass("follow_user").addClass("unfollow_user").attr("id","unfollow_user").html("Dejar de seguir"),app.toast("Ahora sigues un nuevo "+i+"."),void a(o,i)):void 0}),e("body").on("click","#unfollow_user",function(){var t=e(this).hasClass("special_icon")?!0:!1,r=e(this).data("id"),n=e(this).data("userrole"),o=e(this).data("userlogin"),i=n&&""!=n?e(this).data("userrole"):"usuario";i="suscriptor"==i?"museógrafo":i;var s=apiRH.makeRequest(user+"/unfollow",{user_id:r});return s.success?t?(e(this).removeClass("unfollow_user").addClass("follow_user").attr("id","follow_user").html('<i class="fa fa-user"></i> <i class="fa fa-plus superscript"></i>'),void app.toast("Has dejado de seguir un "+i)):(e(this).removeClass("unfollow_user").addClass("follow_user").attr("id","follow_user").html("Seguir"),app.toast("Has dejado de seguir un "+i),void a(o,i)):void 0}),e("body").on("submit","#recomend_to",function(a){a.preventDefault();var t=app.getFormData("#recomend_to"),r=apiRH.makeRequest(user+"/recomend",{evento_id:t.event_id,user_reco:t.user_rec,mensaje:t.comment});r&&(e(".close_dialog").trigger("click"),app.toast("Invitación enviada!"))}),e("body").on("submit","#modify_profile",function(e){e.preventDefault();var a=app.getFormData("#modify_profile");if(a.password_nuevo&&""!==a.password_nuevo){if(a.password_nuevo==a.password_again){var t=apiRH.putRequest("user/"+user+"/password/",a);if(!t.success)return app.toast("There was an error saving your password"),!1}app.toast("Tus passwords no coinciden")}var t=apiRH.putRequest("user/"+user+"/",a);t.success&&app.toast("Tu información ha sido actualizada")}),e(document).on("tap",".login_button",function(){var a=e(this).data("provider");"facebook"==a&&apiRH.loginOauth(a,apiRH.loginCallbackFB),"twitter"==a&&apiRH.loginOauth(a,apiRH.loginCallbackTW)}),e(document).on("tap","#load_more_posts",function(a){a.preventDefault();var t=e(this).data("page");app.get_user_timeline(t),a.stopPropagation()}),e(document).on("tap","#load_more_results",function(a){a.preventDefault();var t=e(this).data("page"),r=app.getUrlVars();app.get_search_results(r.searchbox,t),a.stopPropagation()}),e("#attend_event").on("tap",function(){var a=e(this).data("eventid"),t=apiRH.makeRequest(user+"/events/attend",{post_ID:a});t.success&&e(this).removeClass("attend_event").addClass("attended_event").html('Asistido <i class="fa fa-check-square-o">')}),e("body").on("tap",".gallery_thumb",function(a){return e(this).hasClass("user")?(app.trigger_user_gallery(e(this).data("index")),setTimeout(user_gallery.init(),600),void a.preventDefault()):(app.trigger_event_gallery(e(this).data("index")),setTimeout(event_gallery.init(),600),void a.preventDefault())}),e("#comment_button").on("tap",function(){var a=e("#hidden_event_id").val(),t=e("#comment_content").val(),r=apiRH.makeRequest(user+"/events/comments/",{event_id:a,comment_content:t});return r.success?void window.location.reload():void app.toast("Ha ocurrido un error al postear tu comentario")}),e("#user_rec").on("change keyup",function(){var a=e(this).val(),t="",r=apiRH.getRequest(user+"/search/"+a,null);r.data.forEach(function(e){t+="<li class='fill_input' data-value='"+e+"'>"+e+"</li>"}),e("#hidden_list").html(t).show().delay(6e3).fadeOut("fast")}),e(document).on("tap",".fill_input",function(){var a=e(this).data("value");e("#user_rec").val(a),e("#hidden_list").html("").fadeOut("fast")}),e(document).on("tap","a[rel=external]",function(){app.showLoader()}),e(document).on("tap","._nav_follow_category",function(a){a.preventDefault();var t=e(this),r=e(this).data("id"),n=apiRH.makeRequest(user+"/categories/follow/",{cat_id:r});return a.stopPropagation(),n.success?(app.toast("Sigues una nueva categoría"),t.removeClass("_nav_follow_category follow_category").addClass("_nav_unfollow_category unfollow_category"),t.hasClass("inline")?void t.html('<i class="fa fa-check"></i>'):(t.html('<i class="fa fa-check"></i> Siguiendo'),void a.stopPropagation())):app.toast("Oops! ocurrió un error")}),e(document).on("tap","._nav_unfollow_category",function(a){a.preventDefault();var t=e(this),r=e(this).data("id"),n=apiRH.makeRequest(user+"/categories/unfollow/",{cat_id:r});return a.stopPropagation(),n.success?(app.toast("Dejaste de seguir una categoría"),t.removeClass("_nav_unfollow_category unfollow_category").addClass("_nav_follow_category follow_category"),t.hasClass("inline")?void t.html('<i class="fa fa-plus-circle"></i>'):void t.html('<i class="fa fa-plus-circle"></i> Seguir')):app.toast("Oops! ocurrió un error")}),e("#event_upload_trigger").on("tap",function(){e(this).fadeOut("fast",function(){e("#event_file_upload").fadeIn().removeClass("invisibo"),e("#event_camera_upload").fadeIn().removeClass("invisibo")})}),e("#event_file_upload").on("tap",function(){var a=window.localStorage;a.setItem("museo_last_selected_event",e(this).data("eventid")),app.get_file_from_device("event","gallery")}),e("#event_camera_upload").on("tap",function(){var a=window.localStorage;a.setItem("museo_last_selected_event",e(this).data("eventid")),app.get_file_from_device("event","camera")}),e("#mod_user_profile").on("tap",function(){app.get_file_from_device("profile","gallery")})});